<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-i18n="sidebarHeading">Settings</title>
  <!-- Подключаем шрифт Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Подключаем внешний CSS-файл для настроек -->
  <link rel="stylesheet" href="settings.css">
</head>
<body>
  <!-- Вертикальный сайдбар -->
  <aside class="sidebar">
    <h1 data-i18n="sidebarHeading">Settings</h1>
    <ul class="nav-links">
      <li><a href="#bot-settings" class="nav-link" data-i18n="nav.bot">Bot</a></li>
      <li><a href="#skins" class="nav-link" data-i18n="nav.skins">Skins</a></li>
      <li><a href="#drop-mode" class="nav-link" data-i18n="nav.dropMode">Drop Mode</a></li>
      <li><a href="#rarity" class="nav-link" data-i18n="nav.rarity">Rarity</a></li>
      <li><a href="#scroll-settings" class="nav-link">Scroll Settings</a></li>
      <li><a href="#rarity-skins-count" class="nav-link">Rarity Skins Count</a></li>
    </ul>
    <!-- Переключатель языка -->
    <div class="language-switcher">
      <button class="lang-btn" data-lang="en">ENG</button>
      <button class="lang-btn" data-lang="uk">УКР</button>
      <button class="lang-btn" data-lang="ru">РУ</button>
    </div>
  </aside>

  <!-- Основной контент страницы настроек -->
  <main class="main-content">
    <form id="settingsForm">
      <!-- Настройки бота -->
      <section class="section" id="bot-settings">
        <h2 data-i18n="section.botSettings">Bot Settings</h2>
        <div class="form-group">
          <label for="botUsername" data-i18n="label.botUsername">BOT_USERNAME</label>
          <input type="text" id="botUsername" name="botUsername" required>
        </div>
        <div class="form-group">
          <label for="botOAuth" data-i18n="label.botOAuth">BOT_OAUTH</label>
          <input type="text" id="botOAuth" name="botOAuth" required>
        </div>
        <div class="form-group">
          <label for="channelName" data-i18n="label.channelName">CHANNEL_NAME</label>
          <input type="text" id="channelName" name="channelName" required>
        </div>
        <div class="form-group">
          <label for="chatDelay" data-i18n="label.chatDelay">Chat Delay (sec.)</label>
          <input type="number" id="chatDelay" name="chatDelay" min="0" value="130" required>
        </div>
      </section>
      
      <!-- Секция скинов -->
      <section class="section" id="skins">
        <h2 data-i18n="section.skins">Skins</h2>
        <div class="table-wrapper">
          <table id="skinsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Weapon Type</th>
                <th>Image (File)</th>
                <th>Rarity</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Динамические строки будут добавляться сюда -->
            </tbody>
          </table>
        </div>
        <button type="button" id="addSkinBtn" class="btn" data-i18n="btn.addSkin">Add Skin</button>
      </section>
      
      <!-- Режим выпадения скина -->
      <section class="section" id="drop-mode">
        <h2 data-i18n="section.dropMode">Skin Drop Mode</h2>
        <div class="form-group">
          <label for="dropMode" data-i18n="label.dropMode">Select Mode</label>
          <select id="dropMode" name="dropMode">
            <option value="random">Random by Rarity</option>
            <option value="preset">Preset Skin</option>
          </select>
        </div>
        <div class="form-group" id="presetSkinSelect" style="display: none;">
          <label for="fixedSkin" data-i18n="label.fixedSkin">Select Skin for Drop</label>
          <select id="fixedSkin" name="fixedSkin">
            <!-- Динамические опции -->
          </select>
        </div>
      </section>
      
      <!-- Настройки прокрутки скинов -->
      <section class="section" id="scroll-settings">
        <h2>Scroll Settings</h2>
        <div class="form-group">
          <label for="scrollSpeedPreset">Preset Skin Scroll Speed (sec)</label>
          <input type="number" id="scrollSpeedPreset" name="scrollSpeedPreset" value="10" step="0.1" required>
        </div>
        <div class="form-group">
          <label for="scrollSpeedRandom">Random Skin Scroll Speed (sec)</label>
          <input type="number" id="scrollSpeedRandom" name="scrollSpeedRandom" value="5" step="0.1" required>
        </div>
        <div class="form-group">
          <label for="skinsCount">Global Number of Skins to Show</label>
          <input type="number" id="skinsCount" name="skinsCount" value="20" required>
        </div>
      </section>
      
      <!-- Настройки количества скинов для каждой редкости -->
      <section class="section" id="rarity-skins-count">
        <h2>Rarity Skins Count</h2>
        <div class="form-group">
          <label for="milSpecSkinsCount">Mil-Spec</label>
          <input type="number" id="milSpecSkinsCount" name="milSpecSkinsCount" value="20" required>
        </div>
        <div class="form-group">
          <label for="restrictedSkinsCount">Restricted</label>
          <input type="number" id="restrictedSkinsCount" name="restrictedSkinsCount" value="20" required>
        </div>
        <div class="form-group">
          <label for="classifiedSkinsCount">Classified</label>
          <input type="number" id="classifiedSkinsCount" name="classifiedSkinsCount" value="20" required>
        </div>
        <div class="form-group">
          <label for="covertSkinsCount">Covert</label>
          <input type="number" id="covertSkinsCount" name="covertSkinsCount" value="20" required>
        </div>
        <div class="form-group">
          <label for="rareSpecialSkinsCount">Rare Special Items</label>
          <input type="number" id="rareSpecialSkinsCount" name="rareSpecialSkinsCount" value="20" required>
        </div>
      </section>
      
      <!-- Шансы выпадения по редкости -->
      <section class="section" id="rarity">
        <h2 data-i18n="section.rarity">Drop Rarity</h2>
        <div class="form-group">
          <label for="chanceMilSpec" data-i18n="label.chanceMilSpec">Mil-Spec (%)</label>
          <input type="number" id="chanceMilSpec" name="chanceMilSpec" value="79.9" step="0.1" required>
        </div>
        <div class="form-group">
          <label for="chanceRestricted" data-i18n="label.chanceRestricted">Restricted (%)</label>
          <input type="number" id="chanceRestricted" name="chanceRestricted" value="16" step="0.1" required>
        </div>
        <div class="form-group">
          <label for="chanceClassified" data-i18n="label.chanceClassified">Classified (%)</label>
          <input type="number" id="chanceClassified" name="chanceClassified" value="3.2" step="0.1" required>
        </div>
        <div class="form-group">
          <label for="chanceCovert" data-i18n="label.chanceCovert">Covert (%)</label>
          <input type="number" id="chanceCovert" name="chanceCovert" value="0.64" step="0.01" required>
        </div>
        <div class="form-group">
          <label for="chanceRareSpecial" data-i18n="label.chanceRareSpecial">Rare Special Items (%)</label>
          <input type="number" id="chanceRareSpecial" name="chanceRareSpecial" value="0.125" step="0.001" required>
        </div>
      </section>
      
      <!-- Кнопка сохранения настроек -->
      <section class="section submit-section">
        <button type="submit" class="btn" data-i18n="btn.saveSettings">Save Settings</button>
      </section>
    </form>
    
    <div class="status-message" id="message"></div>
    <div id="currentConfig">
      <h3>Current Configuration</h3>
      <pre id="configPreview"></pre>
    </div>
  </main>

  <script>
    let currentLanguage = "en";
    const translations = {
      ru: {
        sidebarHeading: "Настройки",
        nav: { bot: "Бот", skins: "Скины", dropMode: "Выпадение", rarity: "Редкость" },
        section: { botSettings: "Настройки бота", skins: "Скины", dropMode: "Режим выпадения скина", rarity: "Редкость выпадения" },
        label: {
          botUsername: "BOT_USERNAME",
          botOAuth: "BOT_OAUTH",
          channelName: "CHANNEL_NAME",
          chatDelay: "Delay отправки (сек.)",
          dropMode: "Выберите режим",
          fixedSkin: "Выберите скин для выпадения",
          chanceMilSpec: "Mil-Spec (%)",
          chanceRestricted: "Restricted (%)",
          chanceClassified: "Classified (%)",
          chanceCovert: "Covert (%)",
          chanceRareSpecial: "Rare Special Items (%)"
        },
        btn: { addSkin: "Добавить скин", saveSettings: "Сохранить настройки" },
        previewTitle: "Текущая конфигурация",
        error: {
          settingsLoad: "Ошибка загрузки настроек",
          settingsSave: "Ошибка сохранения настроек",
          raritySum: "Ошибка: Сумма процентов выпадения должна быть равна 100%. Сейчас: "
        }
      },
      en: {
        sidebarHeading: "Settings",
        nav: { bot: "Bot", skins: "Skins", dropMode: "Drop Mode", rarity: "Rarity" },
        section: { botSettings: "Bot Settings", skins: "Skins", dropMode: "Skin Drop Mode", rarity: "Drop Rarity" },
        label: {
          botUsername: "BOT_USERNAME",
          botOAuth: "BOT_OAUTH",
          channelName: "CHANNEL_NAME",
          chatDelay: "Chat Delay (sec.)",
          dropMode: "Select mode",
          fixedSkin: "Select skin for drop",
          chanceMilSpec: "Mil-Spec (%)",
          chanceRestricted: "Restricted (%)",
          chanceClassified: "Classified (%)",
          chanceCovert: "Covert (%)",
          chanceRareSpecial: "Rare Special Items (%)"
        },
        btn: { addSkin: "Add Skin", saveSettings: "Save Settings" },
        previewTitle: "Current Configuration",
        error: {
          settingsLoad: "Error loading settings",
          settingsSave: "Error saving settings",
          raritySum: "Error: The sum of drop percentages must equal 100%. Current: "
        }
      },
      uk: {
        sidebarHeading: "Налаштування",
        nav: { bot: "Бот", skins: "Скіни", dropMode: "Випадання", rarity: "Рідкість" },
        section: { botSettings: "Налаштування бота", skins: "Скіни", dropMode: "Режим випадання скіна", rarity: "Рідкість випадання" },
        label: {
          botUsername: "BOT_USERNAME",
          botOAuth: "BOT_OAUTH",
          channelName: "CHANNEL_NAME",
          chatDelay: "Затримка чату (сек.)",
          dropMode: "Виберіть режим",
          fixedSkin: "Виберіть скін для випадання",
          chanceMilSpec: "Mil-Spec (%)",
          chanceRestricted: "Restricted (%)",
          chanceClassified: "Classified (%)",
          chanceCovert: "Covert (%)",
          chanceRareSpecial: "Rare Special Items (%)"
        },
        btn: { addSkin: "Додати скін", saveSettings: "Зберегти налаштування" },
        previewTitle: "Поточна конфігурація",
        error: {
          settingsLoad: "Помилка завантаження налаштувань",
          settingsSave: "Помилка збереження налаштувань",
          raritySum: "Помилка: Сума відсотків випадання має дорівнювати 100%. Зараз: "
        }
      }
    };

    function getTranslation(key, lang) {
      return key.split('.').reduce((obj, k) => (obj || {})[k], translations[lang]) || key;
    }
    function updateTranslations() {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        el.textContent = getTranslation(key, currentLanguage);
      });
      document.title = getTranslation("sidebarHeading", currentLanguage);
    }
    document.querySelectorAll(".lang-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        currentLanguage = btn.getAttribute("data-lang");
        updateTranslations();
        updatePreview();
      });
    });

    const rarityColors = {
      "Mil-Spec": "#4B58E3",
      "Restricted": "#AF5DE5",
      "Classified": "#F92177",
      "Covert": "#E92E2E",
      "Rare Special Items": "#EFA640"
    };
    function updateRarityColor(selectElement) {
      const color = rarityColors[selectElement.value] || '#000';
      const indicator = selectElement.parentElement.querySelector('.rarity-color');
      if (indicator) {
        indicator.style.backgroundColor = color;
      }
    }
    function updateFixedSkinOptions() {
      const fixedSkinSelect = document.getElementById('fixedSkin');
      const currentValue = fixedSkinSelect.value;
      fixedSkinSelect.innerHTML = '';
      const rows = document.querySelectorAll('#skinsTable tbody tr');
      rows.forEach((row, index) => {
        const skinName = row.querySelector('.skinName').value;
        const option = document.createElement('option');
        option.value = index;
        option.textContent = skinName;
        fixedSkinSelect.appendChild(option);
      });
      if (currentValue !== undefined && fixedSkinSelect.querySelector(`option[value="${currentValue}"]`)) {
        fixedSkinSelect.value = currentValue;
      }
    }
    async function uploadFile(file) {
      const formData = new FormData();
      formData.append('file', file);
      const resp = await fetch('/upload-skin', { method: 'POST', body: formData });
      if (!resp.ok) throw new Error('File upload failed');
      return await resp.json();
    }
    function buildConfigObject() {
      const config = {
        BOT_USERNAME: document.getElementById('botUsername').value,
        BOT_OAUTH: document.getElementById('botOAuth').value,
        CHANNEL_NAME: document.getElementById('channelName').value,
        chatDelay: document.getElementById('chatDelay').value,
        dropMode: document.getElementById('dropMode').value,
        fixedSkin: null,
        skins: []
      };
      const rows = document.querySelectorAll('#skinsTable tbody tr');
      rows.forEach(row => {
        const nameInput = row.querySelector('.skinName');
        const weaponInput = row.querySelector('.weaponType');
        const fileInput = row.querySelector('.skinImage');
        const raritySelect = row.querySelector('.skinRarity');

        const filePath = fileInput.dataset.filePath || '';
        const imageName = filePath ? filePath.split('/').pop() : '';

        config.skins.push({
          name: nameInput.value,
          weapontype: weaponInput.value || '',
          image: filePath,
          imageName,
          rarity: raritySelect.value
        });
      });
      if (config.dropMode === 'preset') {
        const fixedIndex = document.getElementById('fixedSkin').value;
        config.fixedSkin = config.skins[fixedIndex] || null;
      }
      config.rarityChances = {
        "Mil-Spec": parseFloat(document.getElementById('chanceMilSpec').value),
        "Restricted": parseFloat(document.getElementById('chanceRestricted').value),
        "Classified": parseFloat(document.getElementById('chanceClassified').value),
        "Covert": parseFloat(document.getElementById('chanceCovert').value),
        "Rare Special Items": parseFloat(document.getElementById('chanceRareSpecial').value)
      };
      config.scrollSpeedPreset = parseFloat(document.getElementById('scrollSpeedPreset').value);
      config.scrollSpeedRandom = parseFloat(document.getElementById('scrollSpeedRandom').value);
      config.skinsCount = parseInt(document.getElementById('skinsCount').value);

      // Собираем настройки для каждого уровня редкости
      config.raritySkinsCount = {
        "Mil-Spec": parseInt(document.getElementById('milSpecSkinsCount').value),
        "Restricted": parseInt(document.getElementById('restrictedSkinsCount').value),
        "Classified": parseInt(document.getElementById('classifiedSkinsCount').value),
        "Covert": parseInt(document.getElementById('covertSkinsCount').value),
        "Rare Special Items": parseInt(document.getElementById('rareSpecialSkinsCount').value)
      };
      return config;
    }
    function updatePreview() {
      const config = buildConfigObject();
      const sum = Object.values(config.rarityChances).reduce((a, b) => a + b, 0);
      const messageEl = document.getElementById('message');
      if (Math.abs(sum - 100) > 0.01) {
        messageEl.textContent = getTranslation("error.raritySum", currentLanguage) + sum.toFixed(2) + "%.";
        messageEl.style.color = "red";
      } else {
        messageEl.textContent = "";
      }
      document.getElementById('configPreview').textContent = JSON.stringify(config, null, 2);
      updateFixedSkinOptions();
    }
    function saveSettings() {
      const config = buildConfigObject();
      const sum = Object.values(config.rarityChances).reduce((a, b) => a + b, 0);
      const messageEl = document.getElementById('message');
      if (Math.abs(sum - 100) > 0.01) {
        messageEl.textContent = getTranslation("error.raritySum", currentLanguage) + sum.toFixed(2) + "%.";
        messageEl.style.color = "red";
        return;
      } else {
        messageEl.textContent = "";
      }
      document.getElementById('configPreview').textContent = JSON.stringify(config, null, 2);

      fetch("/save-settings", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(config)
      })
        .then(r => r.json())
        .then(data => {
          document.getElementById("message").textContent = data.message;
          document.getElementById("message").style.color = "inherit";
        })
        .catch(err => {
          document.getElementById("message").textContent = getTranslation("error.settingsSave", currentLanguage);
          document.getElementById("message").style.color = "red";
          console.error(err);
        });
    }
    function addSkinRow(skin = {}) {
      const tbody = document.querySelector('#skinsTable tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <input type="text" class="skinName" value="${skin.name || ''}" placeholder="Name" required>
        </td>
        <td>
          <input type="text" class="weaponType" value="${skin.weapontype || ''}" placeholder="Weapon Type">
        </td>
        <td>
          <input type="file" class="skinImage" accept="image/*">
          <span class="fileName">${skin.image ? skin.image.split('/').pop() : ''}</span>
        </td>
        <td>
          <div class="rarity-container">
            <select class="skinRarity" required>
              <option value="Mil-Spec" ${skin.rarity === 'Mil-Spec' ? 'selected' : ''}>Mil-Spec</option>
              <option value="Restricted" ${skin.rarity === 'Restricted' ? 'selected' : ''}>Restricted</option>
              <option value="Classified" ${skin.rarity === 'Classified' ? 'selected' : ''}>Classified</option>
              <option value="Covert" ${skin.rarity === 'Covert' ? 'selected' : ''}>Covert</option>
              <option value="Rare Special Items" ${skin.rarity === 'Rare Special Items' ? 'selected' : ''}>Rare Special Items</option>
            </select>
            <span class="rarity-color"></span>
          </div>
        </td>
        <td>
          <button type="button" class="removeSkinBtn">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);

      const nameInput = tr.querySelector('.skinName');
      const weaponInput = tr.querySelector('.weaponType');
      const fileInput = tr.querySelector('.skinImage');
      const fileNameSpan = tr.querySelector('.fileName');
      const raritySelect = tr.querySelector('.skinRarity');
      const removeBtn = tr.querySelector('.removeSkinBtn');

      if (skin.image) {
        fileInput.dataset.filePath = skin.image;
      }

      nameInput.addEventListener('input', updatePreview);
      weaponInput.addEventListener('input', updatePreview);

      fileInput.addEventListener('change', async () => {
        if (fileInput.files && fileInput.files[0]) {
          try {
            const result = await uploadFile(fileInput.files[0]);
            fileInput.dataset.filePath = result.path;
            fileNameSpan.textContent = result.path.split('/').pop();
            updatePreview();
            saveSettings();
          } catch (e) {
            console.error('File upload error:', e);
          }
        } else {
          fileInput.dataset.filePath = '';
          fileNameSpan.textContent = '';
          updatePreview();
          saveSettings();
        }
      });

      raritySelect.addEventListener('change', function() {
        updateRarityColor(raritySelect);
        updatePreview();
      });
      updateRarityColor(raritySelect);

      removeBtn.addEventListener('click', function() {
        tr.remove();
        updatePreview();
      });

      updatePreview();
    }

    function updateActiveNav() { /* Реализуйте при необходимости */ }
    window.addEventListener("scroll", updateActiveNav);
    document.querySelectorAll(".nav-links li a").forEach(link => {
      link.addEventListener("click", () => {
        setTimeout(updateActiveNav, 100);
      });
    });

    document.addEventListener("DOMContentLoaded", function() {
      fetch("/get-settings")
        .then(r => r.json())
        .then(data => {
          document.getElementById("botUsername").value = data.BOT_USERNAME || "";
          document.getElementById("botOAuth").value = data.BOT_OAUTH || "";
          document.getElementById("channelName").value = data.CHANNEL_NAME || "";
          document.getElementById("chatDelay").value = data.chatDelay || 130;

          document.getElementById("dropMode").value = data.dropMode || "random";
          if (data.dropMode === "preset") {
            document.getElementById("presetSkinSelect").style.display = "block";
          }

          if (data.skins && Array.isArray(data.skins)) {
            data.skins.forEach(skin => {
              addSkinRow({
                name: skin.name,
                weapontype: skin.weapontype || "",
                rarity: skin.rarity,
                image: skin.image || ""
              });
            });
          }

          if (data.rarityChances) {
            document.getElementById("chanceMilSpec").value = data.rarityChances["Mil-Spec"] || 79.9;
            document.getElementById("chanceRestricted").value = data.rarityChances["Restricted"] || 16;
            document.getElementById("chanceClassified").value = data.rarityChances["Classified"] || 3.2;
            document.getElementById("chanceCovert").value = data.rarityChances["Covert"] || 0.64;
            document.getElementById("chanceRareSpecial").value = data.rarityChances["Rare Special Items"] || 0.125;
          }
          document.getElementById("scrollSpeedPreset").value = data.scrollSpeedPreset || 10;
          document.getElementById("scrollSpeedRandom").value = data.scrollSpeedRandom || 5;
          document.getElementById("skinsCount").value = data.skinsCount || 20;

          // Загружаем настройки для редкости
          if(data.raritySkinsCount) {
            document.getElementById("milSpecSkinsCount").value = data.raritySkinsCount["Mil-Spec"] || 20;
            document.getElementById("restrictedSkinsCount").value = data.raritySkinsCount["Restricted"] || 20;
            document.getElementById("classifiedSkinsCount").value = data.raritySkinsCount["Classified"] || 20;
            document.getElementById("covertSkinsCount").value = data.raritySkinsCount["Covert"] || 20;
            document.getElementById("rareSpecialSkinsCount").value = data.raritySkinsCount["Rare Special Items"] || 20;
          } else {
            document.getElementById("milSpecSkinsCount").value = 20;
            document.getElementById("restrictedSkinsCount").value = 20;
            document.getElementById("classifiedSkinsCount").value = 20;
            document.getElementById("covertSkinsCount").value = 20;
            document.getElementById("rareSpecialSkinsCount").value = 20;
          }

          updatePreview();
          updateActiveNav();
          updateTranslations();
        })
        .catch(err => {
          document.getElementById("message").textContent = getTranslation("error.settingsLoad", currentLanguage);
          document.getElementById("message").style.color = "red";
          console.error(err);
        });

      document.getElementById("botUsername").addEventListener("input", updatePreview);
      document.getElementById("botOAuth").addEventListener("input", updatePreview);
      document.getElementById("channelName").addEventListener("input", updatePreview);
      document.getElementById("chatDelay").addEventListener("input", updatePreview);

      document.getElementById("dropMode").addEventListener("change", function() {
        const presetDiv = document.getElementById("presetSkinSelect");
        presetDiv.style.display = (this.value === "preset") ? "block" : "none";
        updatePreview();
      });
      document.getElementById("fixedSkin").addEventListener("change", updatePreview);

      document.getElementById("addSkinBtn").addEventListener("click", () => {
        addSkinRow();
      });

      document.getElementById("settingsForm").addEventListener("submit", function(e) {
        e.preventDefault();
        saveSettings();
      });
    });
  </script>
</body>
</html>
